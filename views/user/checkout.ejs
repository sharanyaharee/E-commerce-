<!DOCTYPE html>
<html>
  <%- include('../partials/header.ejs')%>

  <!-- Breadcrumb Begin -->
  <div class="breadcrumb-option">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="breadcrumb__links">
            <a href="/"><i class="fa fa-home"></i> Home</a>
            <span>Order Summary</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Breadcrumb End -->

  <!-- Checkout Section Begin -->
  <section class="checkout spad">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <h6 class="coupon__link">
           
          </h6>
        </div>
      </div>
      <form action="/checkout" method="post" class="checkout__form">
       
        <div class="row">
          <div class="col-lg-7">
            <h5>Billing detail</h5>
            <div class="row">
              <div class="checkout__form__checkbox">
                <h6><b>Select Address To Ship</b> <span>*</span></h6>
                <br />
                <% for (let i = 0; i < userAddresses.length; i++) { %>
                <label for="address<%= i %>">
                  <input
                    type="radio"
                    id="address<%= i %>"
                    name="selectedAddress"
                    value="<%= userAddresses[i]._id %>"
                  />
                  <%= userAddresses[i].name %> - <%=userAddresses[i].addressLine
                  %>, <%= userAddresses[i].postCode %> <%= userAddresses[i].city
                  %> <%= userAddresses[i].district%>, <%= userAddresses[i].state
                  %> <%= userAddresses[i].country %>
                  <span class="checkmark"></span>
                </label>
                <% } %>
              </div>

              <div class="col-lg-12">
                <div class="checkout__form__checkbox">
                  <a href="/addAddress?returnUrl=/checkout">Add Address</a>
                </div>
                <div class="d-flex justify-content-between">
                  <div class="cart__btn">
                    <a href="/shop">Continue Shopping</a>
                  </div>
                  <div class="cart__btn">
                    <a href="/cart">Review Cart</a>
                  </div>
                </div>
                             
              </div>
           
            </div>
          </div>
        
          <div class="col-lg-5">
            <div class="checkout__order">
              <h5>Your order</h5>
              <div class="checkout__order">
                <h5>Your order</h5>
                <div class="checkout__order__product">
                  <ul>
                    <li>
                      <span class="top__text">Product Name</span>
                      <span class="top__text__right">Total</span>
                    </li>
                    <% const items = Object.values(cart.item); %> <%
                    items.forEach((item) => { %>
                    <li>
                      <%= item.product.productName %> (<%= item.quantity %>)
                      <span class="right__text">₹ <%= item.totalPrice %></span>
                    </li>
                    <% }); %>

                    <li>
                      Discount
                      <span class="right__text" id="discountAmount"><%= cart.discountAmount%></span>
                    </li>
                    <li>
                      Delivery Charges
                      <span class="right__text"
                        ><span style="color: green">Free</span></span
                      >
                    </li>

                    <li>
                      Expected Delivery Date
                      <span class="right__text">
                        <%= expectedDeliveryDate.toDateString() %>
                      </span>
                    </li>
                  </ul>
                </div>
                <div class="checkout__order__total">
                  <ul>
                    <li>Cart Total <span id="totalCartAmount">₹ <%= cart.totalCartPrice%></span></li>
                  </ul>
                </div>

                <button type="submit" id="sub" class="site-btn ">Place Order</button>
              </div>
            </div>
          </div>
        </div>
      </form>
      <div class="discount__content">
                <h6>Discount codes</h6>
                <form id="couponForm" action="/validateCoupon" method="post">
                  <input type="hidden" name="totalAmount" id="totalCartAmountInput" value="<%= cart?.totalCartPrice%>">
                  <input type="text" placeholder="Enter your coupon code" name="couponCode" id="couponCode" required/>
                  <button type="submit" class="site-btn">Apply</button>
                </form>
              
              </div>
    </div>
  </section>
  
  <!-- Checkout Section End -->


  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById('discountAmount').innerText = "0";
 
      const placeOrderButton = document.getElementById('sub');
      placeOrderButton.addEventListener("click", function (event) {
        event.preventDefault();
        const totalCartPrice = document.querySelector('input[name="totalAmount"]').value;
    const selectedAddressRadio = document.querySelector('input[name="selectedAddress"]:checked');
    const selectedAddress = selectedAddressRadio ? selectedAddressRadio.value : null;
    if (!selectedAddress) {
          Swal.fire({
            icon: "error",
            title: "No Address Selected",
            text: "Please select an address to proceed.",
            confirmButtonColor: "#dc3545",
            confirmButtonText: "OK",
          })}else{
          fetch("/stockCheck")
            .then((response) => response.json())
            .then((stockData) => {
              if (stockData.available) {
                const form = document.createElement('form');
                form.method = 'POST';
                form.action = '/checkout';
    
                const selectedAddressInput = document.createElement('input');
                selectedAddressInput.type = 'hidden';
                selectedAddressInput.name = 'selectedAddress';
                selectedAddressInput.value = selectedAddress;
                form.appendChild(selectedAddressInput);
    
                const totalAmountInput = document.createElement('input');
                totalAmountInput.type = 'hidden';
                totalAmountInput.name = 'totalAmount';
                totalAmountInput.value = totalCartPrice;
                form.appendChild(totalAmountInput);
    
                document.body.appendChild(form);
                form.submit();
              } else {
                Swal.fire({
                  icon: "error",
                  title: "Stock Unavailable",
                  text: "Some products in your cart are out of stock.",
                  confirmButtonColor: "#dc3545",
                  confirmButtonText: "OK",
                });
            }
            })
            .catch((error) => {
              console.error("Error:", error);
            });
          }
          
        })
    })
</script>

<script src="/js/coupon.js"></script>

  <%- include('../partials/footer.ejs') %>
</html>
